<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ workflow_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Mermaid for Flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- JSON Editor -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.2/jsoneditor.min.css" rel="stylesheet"
        type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.10.2/jsoneditor.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#f3f0ff',
                primaryTextColor: '#4b4b4b',
                primaryBorderColor: '#9d7deb',
                lineColor: '#666666',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#ffffff'
            }
        });
    </script>
</head>

<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Home</a>

        <div class="chat-container card">
            <div class="chat-header">
                <h2>{{ workflow_name }}</h2>
                <div class="header-controls">
                    {% if show_header_btn %}
                    <div class="version-selector">
                        {% if max_version == 0 %}
                        <span class="version-label">Version 0</span>
                        {% else %}
                        <label for="version-select">Version</label>
                        <select id="version-select" onchange="switchVersion(this.value)">
                            {% for i in range(max_version + 1) %}
                            <option value="{{ i }}" {% if i==max_version %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                    {% endif %}
                    <button id="header-generate-btn" class="header-btn"
                        style="display: {% if show_header_btn %}flex{% else %}none{% endif %}; background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: default;"
                        onclick="return false;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        Workflow Status: Active
                    </button>
                    <button id="header-workflow-btn" class="header-btn"
                        style="display: {% if show_header_btn %}flex{% else %}none{% endif %};"
                        onclick="viewWorkflow('{{ chat_id }}')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                            </path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        Display Workflow
                    </button>
                </div>
            </div>
            <div class="messages-area" id="messages">
                {% for msg in messages %}
                <div class="message {% if msg['sender'] == 'User' %}user{% else %}other{% endif %}">
                    <div>{{ msg['message'] }}</div>
                    <div class="message-meta">{{ msg['timestamp'] }}</div>
                </div>
                {% endfor %}
                <!-- Thinking Indicator -->
                <div id="thinking" class="message System thinking">
                    Agent is thinking
                    <div class="thinking-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>

            <form method="post" id="chat-form" class="input-area">
                <textarea name="message" id="message-input" class="message-input" placeholder="Type your message..."
                    required autofocus autocomplete="off"></textarea>
                <button type="submit" class="btn">Send</button>
            </form>
        </div>
    </div>

    <!-- Modal for JSON Viewer -->
    <div id="json-modal" class="modal">
        <div class="modal-content card">
            <div class="modal-header">
                <div class="modal-title-group">
                    <h2>Workflow Structure</h2>
                    <div class="view-toggle">
                        <button class="toggle-btn active" onclick="switchView('visual')">Visual Flow</button>
                        <button class="toggle-btn" onclick="switchView('technical')">Technical JSON</button>
                    </div>
                </div>
                <span class="close-modal">&times;</span>
            </div>
            <div id="visual-viewer" class="workflow-visualizer">
                <!-- Graphical steps will be injected here -->
            </div>
            <div id="json-viewer" class="json-viewer-container" style="display: none;">
                <div id="jsoneditor" style="width: 100%; height: 500px;"></div>
            </div>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const chatForm = document.getElementById('chat-form');
        const thinkingIndicator = document.getElementById('thinking');
        const sendBtn = chatForm.querySelector('.btn');

        // Scroll to bottom of chat
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Auto-resize textarea
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Submission logic
        function submitForm() {
            const content = messageInput.value.trim();
            if (content === '') return;
            processMessage(content);
        }

        function processMessage(content) {
            // Add user message to UI immediately
            const ts = new Date().toLocaleString();
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message user';
            userMsgDiv.innerHTML = `<div>${content.replace(/\n/g, '<br>')}</div><div class="message-meta">${ts}</div>`;
            messagesDiv.appendChild(userMsgDiv);

            // Show thinking indicator
            thinkingIndicator.style.display = 'block';
            // Set initial thinking text
            thinkingIndicator.firstChild.textContent = 'Agent is starting...';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Disable interactions
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.readOnly = true;
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.5';

            // 1. Post to Server
            fetch(window.location.href, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: content })
            }).then(response => {
                if (response.ok) {
                    // 2. Open Stream
                    const eventSource = new EventSource(`/stream/{{ chat_id }}`);

                    eventSource.onmessage = function (e) {
                        const data = JSON.parse(e.data);

                        if (data.type === 'log') {
                            // Update thinking text
                            thinkingIndicator.firstChild.textContent = data.content;
                        } else if (data.type === 'final') {
                            eventSource.close();

                            // Hide thinking
                            thinkingIndicator.style.display = 'none';

                            // Append final message
                            const finalMsgDiv = document.createElement('div');
                            finalMsgDiv.className = 'message other';

                            if (data.workflow_generated) {
                                document.getElementById('header-workflow-btn').style.display = 'flex';
                                document.getElementById('header-generate-btn').style.display = 'flex';

                                // Update Title and Header Name
                                if (data.workflow_name) {
                                    document.title = data.workflow_name;
                                    const headerH2 = document.querySelector('.chat-header h2');
                                    if (headerH2) headerH2.textContent = data.workflow_name;
                                }
                            } else {
                                document.getElementById('header-generate-btn').style.display = 'none';
                            }

                            finalMsgDiv.innerHTML = `<div>${data.content.replace(/\n/g, '<br>')}</div><div class="message-meta">${data.timestamp}</div>`;
                            messagesDiv.appendChild(finalMsgDiv);

                            // Re-enable interactions
                            messageInput.readOnly = false;
                            sendBtn.disabled = false;
                            sendBtn.style.opacity = '1';
                            messageInput.focus();

                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        } else if (data.type === 'error') {
                            eventSource.close();
                            alert("Error: " + data.content);
                            messageInput.readOnly = false;
                            sendBtn.disabled = false;
                            sendBtn.style.opacity = '1';
                        }
                    };
                }
            });
        }

        // Handle Enter key
        messageInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitForm();
            }
        });

        // Handle Form Submit (for button clicks)
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            submitForm();
        });

        // JSON Viewer Logic
        let editor = null;
        let currentWorkflowData = null;
        const modal = document.getElementById('json-modal');
        const closeModal = document.querySelector('.close-modal');

        function viewWorkflow(chatId) {
            modal.style.display = 'block';

            // Default to visual view
            switchView('visual');

            fetch(`/get_json/${chatId}`)
                .then(response => response.json())
                .then(data => {
                    currentWorkflowData = data;
                    renderGraphicalWorkflow(data);

                    // Initialize or update JSON editor
                    if (!editor) {
                        const container = document.getElementById('jsoneditor');
                        const options = {
                            mode: 'view',
                            modes: ['view', 'tree', 'text'],
                        };
                        editor = new JSONEditor(container, options);
                    }
                    editor.set(data);
                    editor.expandAll();
                })
                .catch(err => {
                    console.error('Error fetching JSON:', err);
                    alert('Could not load workflow data.');
                });
        }

        function switchView(viewType) {
            const visualViewer = document.getElementById('visual-viewer');
            const jsonViewer = document.getElementById('json-viewer');
            const btns = document.querySelectorAll('.toggle-btn');

            if (viewType === 'visual') {
                visualViewer.style.display = 'block';
                jsonViewer.style.display = 'none';
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                visualViewer.style.display = 'none';
                jsonViewer.style.display = 'block';
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
            }
        }

        function renderGraphicalWorkflow(data) {
            const container = document.getElementById('visual-viewer');
            container.innerHTML = ''; // Clear previous

            if (!data) return;

            // 1. Trigger (Start)
            if (data.microsoft_forms) {
                const trigger = data.microsoft_forms;
                container.appendChild(createStepCard({
                    type: 'trigger',
                    title: 'Start: Form Submission',
                    subtitle: trigger.form_name || 'Workflow Trigger',
                    details: `Collects: ${trigger.fields ? trigger.fields.join(', ') : 'Responses'}`,
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>'
                }));
            }

            // 2. Steps
            if (data.power_automate_workflow && data.power_automate_workflow.steps) {
                data.power_automate_workflow.steps.forEach((step, index) => {
                    container.appendChild(createConnector());

                    let icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>';
                    let typeClass = 'action';

                    if (step.type.toLowerCase().includes('approval')) {
                        icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
                        typeClass = 'approval';
                    } else if (step.type.toLowerCase().includes('notification') || step.type.toLowerCase().includes('email')) {
                        icon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>';
                    }

                    container.appendChild(createStepCard({
                        type: typeClass,
                        title: step.step_name,
                        subtitle: step.type,
                        details: step.description || `Automated ${step.type} action.`,
                        icon: icon
                    }));
                });
            }

            // 3. End
            container.appendChild(createConnector());
            container.appendChild(createStepCard({
                type: 'end',
                title: 'End: Workflow Complete',
                subtitle: 'Success',
                details: 'All automated steps finished successfully.',
                icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'
            }));
        }

        function createStepCard(step) {
            const card = document.createElement('div');
            card.className = `workflow-card ${step.type}`;
            card.innerHTML = `
                <div class="card-icon">${step.icon}</div>
                <div class="card-content">
                    <h3>${step.title}</h3>
                    <h4>${step.subtitle}</h4>
                    <p>${step.details}</p>
                </div>
            `;
            return card;
        }

        function createConnector() {
            const connector = document.createElement('div');
            connector.className = 'workflow-connector';
            connector.innerHTML = '<div class="line"></div><div class="arrow"></div>';
            return connector;
        }

        closeModal.onclick = function () {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function switchVersion(version) {
            if (!confirm(`Switch to version ${version}? This will create a new version based on its state.`)) {
                // Reset dropdown to max version
                document.getElementById('version-select').value = '{{ max_version }}';
                return;
            }

            fetch('/select_version', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: '{{ chat_id }}',
                    version: version
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Refresh the page to show the updated workflow and version list
                        window.location.reload();
                    } else {
                        alert('Error switching version: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('An error occurred while switching versions.');
                });
        }
    </script>
</body>

</html>